# Гео-фильтр
Разрешить/запретить трафик в nftables, используя блоки IP для конкретной страны

# Требования
Для этого скрипта требуется nftables >= 0.9.0

# Установка
Скачайте скрипт отсюда:
https://raw.githubusercontent.com/rpthms/nft-geo-filter/master/nft-geo-filter

# TL;DR
Запустите `nft-geo-filter --table-family netdev --interface <interface_to_internet>
XX` для блокировки пакетов из страны, чей код страны ISO-3166-1 alpha-2
ХХ. Замените `<interface_to_internet>` именем интерфейса в вашей системе.
который подключен к Интернету (например: - eth0).

# Описание
Этот скрипт загрузит блоки IPv4 и/или IPv6 для указанных стран.
от одного из поддерживаемых поставщиков IP-блоков и добавить их в наборы в
указанная таблица. Вы должны указать двухбуквенный код страны ISO-3166-1 alpha-2.
стран, которые вы хотите отфильтровать в качестве позиционных аргументов для этого скрипта.

На данный момент nft-geo-filter поддерживает 2 поставщиков IP-блоков:

* **ipverse.net** - http://ipverse.net/
* **ipdeny.com** - https://www.ipdeny.com/ipblocks/

Вы можете указать, какая таблица содержит наборы и правила фильтрации, используя
Флаги `--table-family` и `--table-name`. `--table-name` указывает имя
Таблица. nft-geo-filter требует свою собственную приватную таблицу, поэтому убедитесь, что
имя таблицы, которое вы предоставляете, не используется какой-либо другой таблицей в вашем
набор правил. `--table-family` указывает семейство таблиц nftables, которое будет
сохранить наборы фильтров и правило фильтрации. Семья должна быть одним из
следующие варианты:

* ip
* ip6
* инет
* сетевой разработчик

Используя отдельную таблицу, этот скрипт может создавать собственные цепочки и добавлять свои
собственные правила фильтрации без необходимости внесения администратором каких-либо изменений в их
nftables, как вы должны были сделать в предыдущей версии этого
сценарий. **Не добавляйте никаких правил к цепочкам внутри приватной папки nft-geo-filter.
table**, потому что они будут удалены при повторном запуске скрипта для обновления
наборы фильтров.

**Действием этого скрипта по умолчанию является блокировка трафика** с IP-блоков
предоставленные страны и разрешить все остальное. Чтобы инвертировать это поведение и
разрешать трафик только с IP-блоков указанных стран (с небольшим
исключения, см. раздел «Разрешить исключения режима» ниже), используйте параметр `--allow`
флаг.

Запуск nft-geo-filter без указания дополнительных флагов завершится
создание наборов IP-адресов и правил фильтрации для блокировки трафика с этих IP-адресов внутри
таблица под названием «геофильтр» семейства «инет». Но **рекомендуется использовать
таблица 'netdev' для отбрасывания пакетов** намного эффективнее, чем другие
семьи. См. раздел «netdev» ниже.

# IPv4 или IPv6?

Наборы фильтров, добавляемые в таблицу, определяются семейством таблицы.
которые вы указываете с помощью `--table-family`:

Семейный стол | Наборы фильтров
-------------|------------
ip|Только набор IPv4
ip6|Только набор IPv6
inet|Наборы IPv4 и IPv6
netdev|И IPv4, и IPv6 установлены по умолчанию. Используйте флаг --no-ipv6, чтобы использовать только набор IPv4, или флаг --no-ipv4, чтобы использовать только набор IPv6.

# Netdev
Использование таблицы netdev для отбрасывания пакетов более эффективно, чем их отбрасывание.
таблицы других семейств (в 2 раза согласно вики nftables:
https://wiki.nftables.org/wiki-nftables/index.php/Nftables_families#netdev).
Это связано с тем, что правила netdev применяются очень рано в пути пакета (как
как только сетевой адаптер передает пакеты в сетевой стек).

Чтобы использовать таблицу netdev, вам нужно установить для `--table-family` значение `netdev` и
укажите имя интерфейса, подключенного к Интернету, с помощью
Флаг `--interface`. Интерфейс необходим, потому что таблицы netdev работают на
для каждого интерфейса.

# Разрешить неявные исключения режима
Когда вы используете `--allow`, определенные правила автоматически добавляются вместе с
регулярные правила фильтрации, чтобы гарантировать, что ваш обычный трафик не будет затруднен.
Эти правила гарантируют, что:

1. Трафик из диапазонов частных IPv4-адресов и диапазонов локальных IPv6-адресов.
разрешают пройти.
2. Трафик с локального хоста разрешен.
3. Не-IP-трафик, такой как ARP, не блокируется при использовании таблицы netdev.

# Разрешить исходящие подключения к запрещенным IP-адресам
Если вы хотите установить соединения с IP-адресами, которые запрещены
наборы фильтрации, вы можете использовать флаг `--allow-installed`. Это добавит
правило к цепочке фильтров, чтобы разрешить пакеты от всех установленных и связанных
соединения (т.е. первый пакет соединения должен исходить от вашего
хозяин). Первоначальные пакеты с запрещенных IP-адресов всегда будут отклонены.

Этот флаг очень удобен в сочетании с `--allow`, который позволяет вам ограничить
входящие соединения с определенными странами, позволяя создавать исходящие
подключения к любой стране без каких-либо ограничений. Проверьте пример под названием
'Разрешить только входящие пакеты из Монако, но разрешить исходящие соединения
в любую страну» в разделе ниже, чтобы получить представление о
Флаг --allow-installed.

# Ручные исключения
Вы можете создать исключения для нескольких IP-адресов, чтобы они проходили через
настроенные наборы фильтров. Для этого укажите разделенный запятыми список
IP-адреса, которые необходимо исключить из фильтрации с помощью флага `--exceptions`. Этот
создаст правила, которые явно разрешат пакеты с указанного IP
адресов, даже если наборы фильтрации заблокируют их. Проверьте «Использование
примеры» ниже, чтобы увидеть, как можно использовать флаг `--exceptions`.

# Что мне нужно добавить в конфигурацию nftables?
**Ничего!** Так как этот скрипт создает отдельную таблицу nftables для фильтрации
трафик, это не приведет к поломке вашей текущей конфигурации nftables. 
Созданная этим скриптом цепочка "filter-chain" имеет высокий приоритет от -190 до
обеспечить, что:
* Операции Conntrack происходят до начала сопоставления правил этого скрипта.
(Операции отслеживания соединения используют более высокий приоритет -200)
* Правила фильтрации этого скрипта применяются перед вашими
правила (большинство людей не будут использовать цепочку фильтров с таким высоким приоритетом)

# Другие опции
По умолчанию nft-geo-filter использует `/usr/sbin/nft` в качестве пути к двоичному файлу nft.
Если ваш дистрибутив хранит nft в другом месте, укажите это место с помощью
аргумент `--nft-location`.

Вы также можете добавить счетчики в свои правила фильтрации, чтобы увидеть, сколько пакетов было отправлено.
было отброшено/принято. Просто добавьте аргумент `--counter` при вызове
сценарий.

Правила фильтрации также могут регистрировать принимаемые или отбрасываемые ими пакеты по
используя аргументы --log-accept или --log-drop. Вы можете опционально предоставить
префикс к сообщениям журнала для облегчения идентификации, используя `--log-accept-prefix`,
`--log-drop-prefix` и измените уровень серьезности журнала с 'warn' с помощью
 аргументы --log-accept-level и --log-drop-level.

# Текст справки
Запустите `nft-geo-filter -h`, чтобы получить следующий текст справки:
```
использование: nft-geo-filter [-h] [-v] [--версия] [-l МЕСТОПОЛОЖЕНИЕ] [-a] [--разрешить-установить] [-c]
                      [--provider {ipdeny.com,ipverse.net}] [-f {ip,ip6,inet,netdev}] [-n ИМЯ]
                      [-i ИНТЕРФЕЙС] [--no-ipv4 | --no-ipv6] [-p] [--log-accept-prefix ПРЕФИКС]
                      [--log-accept-level {возникновение, предупреждение, крит, ошибка, предупреждение, уведомление, информация, отладка}] [-o]
                      [--log-drop-prefix ПРЕФИКС]
                      [--log-drop-level {появление, оповещение, крит, ошибка, предупреждение, уведомление, информация, отладка}]
                      [-e АДРЕСА]
                      страна [страна ...]

Фильтровать трафик в nftables с помощью блоков IP страны

позиционные аргументы:
  страна 2-буквенный код страны ISO-3166-1 alpha-2 для разрешения/блокировки. Проверьте свой IP
                        блокирует провайдера, чтобы найти список поддерживаемых стран.

необязательные аргументы:
  -h, --help показать это справочное сообщение и выйти
  -v, --verbose показать подробный вывод
  --version показать номер версии программы и выйти

  -l МЕСТОПОЛОЖЕНИЕ, --nft-location МЕСТОПОЛОЖЕНИЕ
                        Расположение двоичного файла nft. По умолчанию /usr/sbin/nft
  -a, --allow По умолчанию все IP-адреса в наборах фильтров будут запрещены, а все остальные
                        IP будет разрешено проходить цепочку фильтрации. Предоставьте этот аргумент
                        изменить это поведение.
  --allow-installed Разрешить пакеты с запрещенных IP-адресов, но только если они являются частью
                        установленное соединение, т. е. исходный пакет исходит от вашего хоста.
                        Первоначальные пакеты с запрещенных IP-адресов все равно будут отброшены. Этот флаг может
                        быть полезным при использовании режима разрешения, чтобы исходящие соединения с
                        адреса за пределами набора фильтров все еще могут быть сделаны.
  -c, --counter Добавить оператор counter в правила фильтрации
  --provider {ipdeny.com,ipverse.net}
                        Укажите страну поставщика блокировок IP-адресов. По умолчанию используется ipverse.net.

Стол:
  Укажите имя и семейство таблицы, в которой будет храниться набор отфильтрованных адресов.
  созданный. Этот сценарий создаст новую таблицу nftables, поэтому убедитесь, что указанное имя таблицы
  уникальна и не используется ни одной другой таблицей в наборе правил. Таблица 'inet' под названием 'geo-
  фильтр будет использоваться по умолчанию

  -f {ip,ip6,inet,netdev}, --table-family {ip,ip6,inet,netdev}
                        Укажите семейство таблицы. По умолчанию инет
  -n ИМЯ, --table-name ИМЯ
                        Укажите имя таблицы. По умолчанию используется геофильтр

Аргументы Netdev:
  Если вы используете таблицу netdev, вам необходимо указать имя интерфейса, который
  подключен к Интернету, потому что таблицы netdev работают для каждого интерфейса. Вы также можете
  выберите хранить только адреса v4 или только адреса v6 внутри наборов таблиц netdev, предоставив
  аргументы --no-ipv6 или --no-ipv4. Адреса v4 и v6 сохраняются по умолчанию.

  -i ИНТЕРФЕЙС, --interface ИНТЕРФЕЙС
                        Укажите входной интерфейс для таблицы netdev
  --no-ipv4 Не создавать набор для адресов v4 в таблице netdev
  --no-ipv6 Не создавать набор для адресов v6 в таблице netdev

Заявление о регистрации:
  При желании вы можете добавить оператор ведения журнала в правила фильтрации, добавленные этим сценарием.
  Таким образом, вы сможете увидеть IP-адреса принятых или отброшенных пакетов.
  по правилам фильтрации в журнале ядра (который можно прочитать через журнал systemd или
  системный журнал). Вы также можете добавить необязательный префикс к сообщениям журнала и изменить сообщение журнала.
  Уровень опасности.

  -p, --log-accept Добавить оператор журнала в правила фильтрации принятия
  --log-accept-prefix ПРЕФИКС
                        Добавьте префикс к сообщениям журнала принятия для облегчения идентификации. Нет
                        префикс используется по умолчанию.
  --log-accept-level {появление, предупреждение, крит, ошибка, предупреждение, уведомление, информация, отладка}
                        Установите уровень серьезности сообщения журнала принятия. По умолчанию «предупреждать».
  -o, --log-drop Добавить оператор журнала в правила фильтрации отбрасывания
  --log-drop-prefix ПРЕФИКС
                        Добавьте префикс к сообщениям журнала отбрасывания для облегчения идентификации. Нет
                        префикс используется по умолчанию.
  --log-drop-level {возникновение, предупреждение, крит, ошибка, предупреждение, уведомление, информация, отладка}
                        Задайте уровень серьезности сообщений журнала отбрасывания. По умолчанию «предупреждать».

Исключения IP:
  Вы можете добавить исключения для определенных IP-адресов, передав список IP-адресов, разделенных запятыми, или
  подсети/префиксы к опции '--exceptions'. IP-адреса, переданные этой опции, будут
  явно разрешено в цепочке фильтрации, созданной этим скриптом. И IPv4, и IPv6
  адреса можно передать. Используйте эту опцию, чтобы разрешить несколько IP-адресов, которые в противном случае были бы
  запрещены вашими фильтрующими наборами.

  -e АДРЕСА, --exceptions АДРЕСА
```

# Примеры использования
Все, что вам нужно сделать, это запустить этот скрипт с соответствующими флагами. Нет никаких
необходимо создать таблицу или установить вручную в конфигурации nftables для
операция фильтрации для работы. Взгляните на следующие примеры, чтобы
понять, как работает скрипт. Я использую блоки IP-адресов из Монако в
следующие примеры:

* Используйте таблицу netdev для блокировки пакетов из Монако (на интерфейсе enp1s0)\
  **Команда для запуска**: `nft-geo-filter --table-family netdev --interface enp1s0 MC`\
  **Результирующий набор правил**:
  ```
  таблица netdev геофильтр {
        установить фильтр-v4 {
                введите ipv4_addr
                интервал флагов
                самостоятельный
                элементы = {37.44.224.0/22, 80.94.96.0/20,
                             82.113.0.0/19, 87.238.104.0/21,
                             87.254.224.0/19, 88.209.64.0/18,
                             91.199.109.0/24, 176.114.96.0/20,
                             185.47.116.0/22, 185.162.120.0/22,
                             185.250.4.0/22, 188.191.136.0/21,
                             194.9.12.0/23, 195.20.192.0/23,
                             195.78.0.0/19, 213.133.72.0/21,
                             213.137.128.0/19 }
        }

        установить фильтр-v6 {
                введите ipv6_addr
                интервал флагов
                самостоятельный
                элементы = { 2a01:8fe0::/32,
                             2а07:9080::/29,
                             2a0b:8000::/29}
        }

        цепочка фильтр-цепочка {
                type filter hook ingress device "enp1s0" приоритет -190; политика принять;
                ip saddr @filter-v4 падение
                ip6 saddr @filter-v6 падение
        }
  }
  ```

* Используйте таблицу netdev, чтобы блокировать пакеты IPv4 только из Монако (на интерфейсе enp1s0)\
  **Команда для запуска**: `nft-geo-filter --table-family netdev --interface enp1s0 --no-ipv6 MC`\
  **Результирующий набор правил**:
  ```
  таблица netdev геофильтр {
        установить фильтр-v4 {
                введите ipv4_addr
                интервал флагов
                самостоятельный
                элементы = {37.44.224.0/22, 80.94.96.0/20,
                             82.113.0.0/19, 87.238.104.0/21,
                             87.254.224.0/19, 88.209.64.0/18,
                             91.199.109.0/24, 176.114.96.0/20,
                             185.47.116.0/22, 185.162.120.0/22,
                             185.250.4.0/22, 188.191.136.0/21,
                             194.9.12.0/23, 195.20.192.0/23,
                             195.78.0.0/19, 213.133.72.0/21,
                             213.137.128.0/19 }
        }

        цепочка фильтр-цепочка {
                type filter hook ingress device "enp1s0" приоритет -190; политика принять;
                ip saddr @filter-v4 падение
        }
  }
  ```

* Разрешить пакеты только из Монако, используя таблицу netdev (на интерфейсе enp1s0)\
  **Команда для запуска**: `nft-geo-filter --table-family netdev --interface enp1s0 --allow MC`\
  **Результирующий набор правил**:
  ```
  таблица netdev геофильтр {
        установить фильтр-v4 {
                введите ipv4_addr
                интервал флагов
                самостоятельный
                элементы = {37.44.224.0/22, 80.94.96.0/20,
                             82.113.0.0/19, 87.238.104.0/21,
                             87.254.224.0/19, 88.209.64.0/18,
                             91.199.109.0/24, 176.114.96.0/20,
                             185.47.116.0/22, 185.162.120.0/22,
                             185.250.4.0/22, 188.191.136.0/21,
                             194.9.12.0/23, 195.20.192.0/23,
                             195.78.0.0/19, 213.133.72.0/21,
                             213.137.128.0/19 }
        }

        установить фильтр-v6 {
                введите ipv6_addr
                интервал флагов
                самостоятельный
                элементы = { 2a01:8fe0::/32,
                             2а07:9080::/29,
                             2a0b:8000::/29}
        }

        цепочка фильтр-цепочка {
                type filter hook ingress device "enp1s0" приоритет -190; падение политики;
                ip6 саддр fe80::/10 принять
                ip саддр {10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16} принять
                метапротокол != {ip, ip6} принять
                ip saddr @filter-v4 принять
                ip6 saddr @filter-v6 принять
        }
  }
  ```

* Используйте таблицу IP-адресов с именем «monaco-filter», чтобы блокировать пакеты IPv4 из Монако и подсчитывать заблокированные пакеты\
  **Команда для запуска**: `nft-geo-filter --table-family ip --table-name monaco-filter --counter MC`\
  **Результирующий набор правил**:
  ```
  таблица ip monaco-filter {
        установить фильтр-v4 {
                введите ipv4_addr
                интервал флагов
                самостоятельный
                элементы = {37.44.224.0/22, 80.94.96.0/20,
                             82.113.0.0/19, 87.238.104.0/21,
                             87.254.224.0/19, 88.209.64.0/18,
                             91.199.109.0/24, 176.114.96.0/20,
                             185.47.116.0/22, 185.162.120.0/22,
                             185.250.4.0/22, 188.191.136.0/21,
                             194.9.12.0/23, 195.20.192.0/23,
                             195.78.0.0/19, 213.133.72.0/21,
                             213.137.128.0/19 }
        }

        цепочка фильтр-цепочка {
                type filter hook prerouting Priority -190; политика принять;
                ip saddr @filter-v4 счетчик пакетов 0 байт 0 падение
        }
  }
  ```

* Используйте таблицу ip6 с именем «monaco-filter-v6», чтобы блокировать пакеты IPv6 из Монако\
  **Команда для запуска**: `nft-geo-filter --table-family ip6 --table-name monaco-filter-v6 MC`\
  **Результирующий набор правил**:
  ```
  таблица ip6 monaco-filter-v6 {
        установить фильтр-v6 {
                введите ipv6_addr
                интервал флагов
                самостоятельный
                элементы = { 2a01:8fe0::/32,
                             2а07:9080::/29,
                             2a0b:8000::/29}
        }

        цепочка фильтр-цепочка {
                type filter hook prerouting Priority -190; политика принять;
                ip6 saddr @filter-v6 падение
        }
  }
  ```

* Разрешить пакеты из Монако только через инет-стол\
  **Команда для запуска**: `nft-geo-filter --allow MC`\
  **Результирующий набор правил**:
  ```
  таблица inet гео-фильтр {
        установить фильтр-v4 {
                введите ipv4_addr
                интервал флагов
                самостоятельный
                элементы = {37.44.224.0/22, 80.94.96.0/20,
                             82.113.0.0/19, 87.238.104.0/21,
                             87.254.224.0/19, 88.209.64.0/18,
                             91.199.109.0/24, 176.114.96.0/20,
                             185.47.116.0/22, 185.162.120.0/22,
                             185.250.4.0/22, 188.191.136.0/21,
                             194.9.12.0/23, 195.20.192.0/23,
                             195.78.0.0/19, 213.133.72.0/21,
                             213.137.128.0/19 }
        }

        установить фильтр-v6 {
                введите ipv6_addr
                интервал флагов
                самостоятельный
                элементы = { 2a01:8fe0::/32,
                             2а07:9080::/29,
                             2a0b:8000::/29}
        }

        цепочка фильтр-цепочка {
                type filter hook prerouting Priority -190; падение политики;
                ip6 saddr { ::1, fe80::/10 } принять
                ip саддр {10.0.0.0/8, 127.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16} принять
                ip saddr @filter-v4 принять
                ip6 saddr @filter-v6 принять
        }
  }
  ```

* Блокировать все пакеты из Монако с помощью таблицы inet (операция по умолчанию)\
  **Команда для запуска**: `nft-geo-filter MC`\
  **Результирующий набор правил**:
  ```
  таблица inet гео-фильтр {
        установить фильтр-v4 {
                введите ipv4_addr
                интервал флагов
                самостоятельный
                элементы = {37.44.224.0/22, 80.94.96.0/20,
                             82.113.0.0/19, 87.238.104.0/21,
                             87.254.224.0/19, 88.209.64.0/18,
                             91.199.109.0/24, 176.114.96.0/20,
                             185.47.116.0/22, 185.162.120.0/22,
                             185.250.4.0/22, 188.191.136.0/21,
                             194.9.12.0/23, 195.20.192.0/23,
                             195.78.0.0/19, 213.133.72.0/21,
                             213.137.128.0/19 }
        }

        установить фильтр-v6 {
                введите ipv6_addr
                интервал флагов
                самостоятельный
                элементы = { 2a01:8fe0::/32,
                             2а07:9080::/29,
                             2a0b:8000::/29}
        }

        цепочка фильтр-цепочка {
                type filter hook prerouting Priority -190; политика принять;
                ip saddr @filter-v4 падение
                ip6 saddr @filter-v6 падение
        }
  }
  ```

* Блокируйте все пакеты из Монако, используя таблицу в сети с именем «monaco-filter» и регистрируйте отброшенные пакеты\
  **Команда для запуска**: `nft-geo-filter --table-name monaco-filter --log-drop MC`\
  **Результирующий набор правил**:
  ```
  таблица inet monaco-filter {
        установить фильтр-v4 {
                введите ipv4_addr
                интервал флагов
                самостоятельный
                элементы = {37.44.224.0/22, 80.94.96.0/20,
                             82.113.0.0/19, 87.238.104.0/21,
                             87.254.224.0/19, 88.209.64.0/18,
                             91.199.109.0/24, 176.114.96.0/20,
                             185.47.116.0/22, 185.162.120.0/22,
                             185.250.4.0/22, 188.191.136.0/21,
                             194.9.12.0/23, 195.20.192.0/23,
                             195.78.0.0/19, 213.133.72.0/21,
                             213.137.128.0/19 }
        }

        установить фильтр-v6 {
                введите ipv6_addr
                интервал флагов
                самостоятельный
                элементы = { 2a01:8fe0::/32,
                             2а07:9080::/29,
                             2a0b:8000::/29}
        }

        цепочка фильтр-цепочка {
                type filter hook prerouting Priority -190; политика принять;
                ip saddr @filter-v4 сброс журнала
                ip6 saddr @filter-v6 сброс журнала
        }
  }
  ```

* Блокировать все пакеты из Монако и регистрировать их, используя префикс журнала «MC-Block» и уровень журнала «info».
  **Команда для запуска**: `nft-geo-filter --log-drop --log-drop-prefix 'MC-Block' --log-drop-level info MC`\
  **Результирующий набор правил**:
  ```
  таблица inet гео-фильтр {
        установить фильтр-v4 {
                введите ipv4_addr
                интервал флагов
                самостоятельный
                элементы = {37.44.224.0/22, 80.94.96.0/20,
                             82.113.0.0/19, 87.238.104.0/21,
                             87.254.224.0/19, 88.209.64.0/18,
                             91.199.109.0/24, 176.114.96.0/20,
                             185.47.116.0/22, 185.162.120.0/22,
                             185.250.4.0/22, 188.191.136.0/21,
                             194.9.12.0/23, 195.20.192.0/23,
                             195.78.0.0/19, 213.133.72.0/21,
                             213.137.128.0/19 }
        }

        установить фильтр-v6 {
                введите ipv6_addr
                интервал флагов
                самостоятельный
                элементы = { 2a01:8fe0::/32,
                             2а07:9080::/29,
                             2a0b:8000::/29}
        }

        цепочка фильтр-цепочка {
                type filter hook prerouting Priority -190; политика принять;
                ip saddr @filter-v4 префикс журнала "MC-Block" информация об уровне выпадает
                ip6 saddr @filter-v6 префикс журнала "MC-Block" уровень информации выпадает
        }
  }
  ```

* Разрешить пакеты только из Монако, но создать исключения для DNS-сервиса Cloudflare\
  **Команда для запуска**: `nft-geo-filter --exceptions 1.0.0.1,1.1.1.1,2606:4700:4700::1001,2606:4700:4700::1111 --allow MC`\
  **Результирующий набор правил**:
  ```
  таблица inet гео-фильтр {
        установить фильтр-v4 {
                введите ipv4_addr
                интервал флагов
                самостоятельный
                элементы = {37.44.224.0/22, 80.94.96.0/20,
                             82.113.0.0/19, 87.238.104.0/21,
                             87.254.224.0/19, 88.209.64.0/18,
                             91.199.109.0/24, 176.114.96.0/20,
                             185.47.116.0/22, 185.162.120.0/22,
                             185.250.4.0/22, 188.191.136.0/21,
                             194.9.12.0/23, 195.20.192.0/23,
                             195.78.0.0/19, 213.133.72.0/21,
                             213.137.128.0/19 }
        }

        установить фильтр-v6 {
                введите ipv6_addr
                интервал флагов
                самостоятельный
                элементы = { 2a01:8fe0::/32,
                             2а07:9080::/29,
                             2a0b:8000::/29}
        }

        цепочка фильтр-цепочка {
                type filter hook prerouting Priority -190; падение политики;
                ip саддр {1.0.0.1, 1.1.1.1} принять
                ip6 saddr { 2606:4700:4700::1001, 2606:4700:4700::1111 } принять
                ip6 saddr { ::1, fe80::/10 } принять
                ip саддр {10.0.0.0/8, 127.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16} принять
                ip saddr @filter-v4 принять
                ip6 saddr @filter-v6 принять
        }
  }
  ```

* Блокировать все пакеты из Монако, кроме пакетов с `80.94.96.0/24` и `2a07:9080:100:100::/64`\
  **Команда для запуска**: `nft-geo-filter --exceptions 80.94.96.0/24,2a07:9080:100:100::/64 MC`\
  **Результирующий набор правил**:
  ```
  таблица inet гео-фильтр {
        установить фильтр-v4 {
                введите ipv4_addr
                интервал флагов
                самостоятельный
                элементы = {37.44.224.0/22, 80.94.96.0/20,
                             82.113.0.0/19, 87.238.104.0/21,
                             87.254.224.0/19, 88.209.64.0/18,
                             91.199.109.0/24, 176.114.96.0/20,
                             185.47.116.0/22, 185.162.120.0/22,
                             185.250.4.0/22, 188.191.136.0/21,
                             194.9.12.0/23, 195.20.192.0/23,
                             195.78.0.0/19, 213.133.72.0/21,
                             213.137.128.0/19 }
        }

        установить фильтр-v6 {
                введите ipv6_addr
                интервал флагов
                самостоятельный
                элементы = { 2a01:8fe0::/32,
                             2а07:9080::/29,
                             2a0b:8000::/29}
        }

        цепочка фильтр-цепочка {
                type filter hook prerouting Priority -190; политика принять;
                ip саддр {80.94.96.0/24} принять
                ip6 саддр { 2a07:9080:100:100::/64 } принять
                ip saddr @filter-v4 падение
                ip6 saddr @filter-v6 падение
        }
  }
  ```

* Разрешить входящие пакеты только из Монако, но разрешить исходящие соединения в любую страну\
  **Команда для запуска**: `nft-geo-filter --allow --allow-installed MC`\
  **Результирующий набор правил**:
  ```
  таблица inet гео-фильтр {
        установить фильтр-v4 {
                введите ipv4_addr
                интервал флагов
                самостоятельный
                элементы = {37.44.224.0/22, 80.94.96.0/20,
                             82.113.0.0/19, 87.238.104.0/21,
                             87.254.224.0/19, 88.209.64.0/18,
                             91.199.109.0/24, 176.114.96.0/20,
                             185.47.116.0/22, 185.162.120.0/22,
                             185.250.4.0/22, 188.191.136.0/21,
                             194.9.12.0/23, 195.20.192.0/23,
                             195.78.0.0/19, 213.133.72.0/21,
                             213.137.128.0/19 }
        }

        установить фильтр-v6 {
                введите ipv6_addr
                интервал флагов
                самостоятельный
                элементы = { 2a01:8fe0::/32,
                             2а07:9080::/29,
                             2a0b:8000::/29}
        }

        цепочка фильтр-цепочка {
                type filter hook prerouting Priority -190; падение политики;
                состояние ct установлено, связанное с принятием
                ip6 saddr { ::1, fe80::/10 } принять
                ip саддр {10.0.0.0/8, 127.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16} принять
                ip saddr @filter-v4 принять
                ip6 saddr @filter-v6 принять
        }
  }
  ```

* Загрузите блоки IP с ipdeny.com вместо ipverse.net, чтобы блокировать пакеты из Монако\
  **Команда для запуска**: `nft-geo-filter --provider ipdeny.com MC`\
  **Результирующий набор правил**:
  ```
  таблица inet гео-фильтр {
        установить фильтр-v4 {
                введите ipv4_addr
                интервал флагов
                самостоятельный
                элементы = {37.44.224.0/22, 80.94.96.0/20,
                             82.113.0.0/19, 87.238.104.0/21,
                             87.254.224.0/19, 88.209.64.0/18,
                             91.199.109.0/24, 91.213.192.0/24,
                             176.114.96.0/20, 185.47.116.0/22,
                             185.162.120.0/22, 185.193.108.0/22,
                             185.250.4.0/22, 188.191.136.0/21,
                             193.34.228.0/23, 193.35.2.0/23,
                             194.9.12.0/23, 195.20.192.0/23,
                             195.78.0.0/19, 213.133.72.0/21 }
        }

        установить фильтр-v6 {
                введите ipv6_addr
                интервал флагов
                самостоятельный
                элементы = { 2a01:8fe0::/32,
                             2a06:92c0::/32,
                             2а07:9080::/29,
                             2a0b:8000::/29,
                             2a0f:b980::/29}
        }

        цепочка фильтр-цепочка {
                type filter hook prerouting Priority -190; политика принять;
                ip saddr @filter-v4 падение
                ip6 saddr @filter-v6 падение
        }
  }
  ```

# Запускаем nft-geo-filter как службу
nft-geo-filter также можно запустить с помощью cronjob или системного таймера, чтобы сохранить
обновлены наборы фильтров. Когда nft-geo-filter выполняется, он проверяет,
наборы целей уже существуют. Если они это сделают, скрипт сбросит существующие
содержимое наборов фильтрации после загрузки IP-блоков, а затем добавить
обновлены IP-блоки для наборов. Если необходимо внести какие-либо изменения в фильтрацию
правила, скрипт их тоже сделает.

* Снова возьмем Монако в качестве примера, чтобы обновить наборы фильтрации в 'ip'
  таблица под названием «monaco-filter» при загрузке системы, а затем каждые 12
  часов после этого ваш системный таймер и сервисные единицы будут выглядеть как-то иначе.
  вот так (при условии, что вы сохранили скрипт nft-geo-filter в
  /usr/локальные/бен):

  **nft-geo-filter.timer**
  ```
  [Ед. изм]
  Description=nftables Country Filter Timer

  [Таймер]
  OnBootSec=1мин
  Онунитактивесек=12ч

  [Установить]
  WantedBy=timers.target
  ```

  **nft-geo-filter.service**
  ```
  [Ед. изм]
  Описание=nftables Фильтр страны

  [Обслуживание]
  Тип = ваншот
  ExecStart=/usr/local/bin/nft-geo-filter --table-family ip --table-name monaco-filter MC
  ```

* Задание cron, которое запускает ту же команду nft-geo-filter, указанную выше, в 3:00.
  каждый день будет выглядеть так:
  ```
  0 3 * * * /usr/local/bin/nft-geo-filter --table-family ip --table-name monaco-filter MC
  ```
